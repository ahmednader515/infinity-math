generator client {
  provider = "prisma-client-js"
  engineType = "binary"
  binaryTargets = ["native", "rhel-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_DATABASE_URL")
}

model User {
  id                      String    @id @default(uuid())
  fullName                String
  phoneNumber             String    @unique
  parentPhoneNumber       String
  hashedPassword          String?
  image                   String?
  role                    String    @default("USER")
  balance                 Float     @default(0)
  grade                   String?   // الصف: الأول، الثاني، الثالث
  division                String?   // القسم: عام، أدبي، علمي، علمي رياضة
  studyType               String?   // نوع الدراسة: سنتر، أون لاين
  governorate             String?   // المحافظة
  createdAt               DateTime  @default(now())
  updatedAt               DateTime  @updatedAt
  courses                 Course[]
  purchases               Purchase[]
  userProgress            UserProgress[]
  balanceTransactions     BalanceTransaction[]
  quizResults             QuizResult[]
  quizAttempts            QuizAttempt[]
  quizStudentSettings     QuizStudentSettings[]
}

model Course {
  id String @id @default(uuid())
  userId String
  title String @db.Text
  description String? @db.Text
  imageUrl String? @db.Text
  price Float?
  isPublished Boolean @default(false)
  grade String? // الصف الدراسي: الأول الثانوي، الثاني الثانوي، الثالث الثانوي، الكل (لجميع الصفوف)
  divisions String[] @default([]) // القسم: يمكن اختيار أكثر من قسم (عام، أدبي، علمي، علمي رياضة، بكالوريا)
  studyTypes String[] @default([]) // نوع الدراسة: ["سنتر"], ["أون لاين"], أو ["سنتر", "أون لاين"]

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  attachments Attachment[]
  chapters Chapter[]
  purchases Purchase[]
  quizzes Quiz[]
  promoCodes PromoCodeCourse[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([grade])
}

model Attachment {
  id String @id @default(uuid())
  name String
  url String @db.Text

  courseId String
  course Course @relation(fields: [courseId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([courseId])
}

model Chapter {
  id String @id @default(uuid())
  title String @db.Text
  description String? @db.Text
  videoUrl String? @db.Text
  videoType String? @default("UPLOAD") // "UPLOAD" or "YOUTUBE"
  youtubeVideoId String? // Store YouTube video ID
  documentUrl String? @db.Text // Store document URL (legacy - for backward compatibility)
  documentName String? // Store original document filename (legacy - for backward compatibility)
  position Int
  isPublished Boolean @default(false)
  isFree Boolean @default(false)
  studyTypes String[] @default([]) // نوع الدراسة: ["سنتر"], ["أون لاين"], أو ["سنتر", "أون لاين"]
  requirePassingQuiz Boolean @default(false) // يجب على الطالب اجتياز الاختبار لرؤية الفصل
  requiredQuizId String? // معرف الاختبار المطلوب اجتيازه
  requiredQuiz Quiz? @relation("ChapterRequiredQuiz", fields: [requiredQuizId], references: [id], onDelete: SetNull)

  courseId String
  course Course @relation(fields: [courseId], references: [id], onDelete: Cascade)

  userProgress UserProgress[]
  attachments ChapterAttachment[] // New relation for multiple documents

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([courseId])
  @@index([requiredQuizId])
}

model ChapterAttachment {
  id String @id @default(uuid())
  name String
  url String @db.Text
  position Int @default(0)

  chapterId String
  chapter Chapter @relation(fields: [chapterId], references: [id], onDelete: Cascade)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([chapterId])
}

model UserProgress {
    id        String   @id @default(uuid())
    userId    String
    chapterId String
    isCompleted Boolean @default(false)
    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    user User @relation(fields: [userId], references: [id], onDelete: Cascade)
    chapter   Chapter  @relation(fields: [chapterId], references: [id], onDelete: Cascade)

    @@unique([userId, chapterId])
    @@index([chapterId])
}

model Purchase {
    id String @id @default(uuid())
    userId String
    courseId String
    status String @default("ACTIVE")
    user User @relation(fields: [userId], references: [id], onDelete: Cascade)
    course Course @relation(fields: [courseId], references: [id], onDelete: Cascade)
    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    @@unique([userId, courseId])
    @@index([courseId])
}

model BalanceTransaction {
    id String @id @default(uuid())
    userId String
    amount Float
    type String // "DEPOSIT" or "PURCHASE"
    description String
    user User @relation(fields: [userId], references: [id], onDelete: Cascade)
    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    @@index([userId])
}

model Quiz {
    id String @id @default(uuid())
    title String
    description String? @db.Text
    position Int
    isPublished Boolean @default(false)
    timer Int? // Timer in minutes, null means no time limit
    maxAttempts Int @default(1) // Maximum number of attempts allowed (default, can be overridden per student)
    courseId String
    course Course @relation(fields: [courseId], references: [id], onDelete: Cascade)
    questions Question[]
    quizResults QuizResult[]
    attempts QuizAttempt[]
    studentSettings QuizStudentSettings[] // Per-student retry limits
    requiredByChapters Chapter[] @relation("ChapterRequiredQuiz") // Chapters that require passing this quiz
    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    @@index([courseId])
}

model Question {
    id String @id @default(uuid())
    text String @db.Text
    type String // "MULTIPLE_CHOICE", "TRUE_FALSE", "SHORT_ANSWER"
    options String? @db.Text // JSON string for multiple choice options
    correctAnswer String @db.Text
    points Int @default(1)
    imageUrl String? @db.Text
    position Int @default(1)
    quizId String
    quiz Quiz @relation(fields: [quizId], references: [id], onDelete: Cascade)
    answers QuizAnswer[]
    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    @@index([quizId])
}

model QuizResult {
    id String @id @default(uuid())
    studentId String
    quizId String
    score Int
    totalPoints Int
    percentage Float
    attemptNumber Int @default(1) // Track which attempt this is
    submittedAt DateTime @default(now())
    user User @relation(fields: [studentId], references: [id], onDelete: Cascade)
    quiz Quiz @relation(fields: [quizId], references: [id], onDelete: Cascade)
    answers QuizAnswer[]
    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    @@index([studentId, quizId])
    @@index([quizId])
}

model QuizAttempt {
    id String @id @default(uuid())
    studentId String
    quizId String
    startedAt DateTime @default(now())
    completedAt DateTime?

    user User @relation(fields: [studentId], references: [id], onDelete: Cascade)
    quiz Quiz @relation(fields: [quizId], references: [id], onDelete: Cascade)

    @@unique([studentId, quizId])
    @@index([studentId])
    @@index([quizId])
}

model QuizAnswer {
    id String @id @default(uuid())
    questionId String
    quizResultId String
    studentAnswer String @db.Text
    correctAnswer String @db.Text
    isCorrect Boolean
    pointsEarned Int
    question Question @relation(fields: [questionId], references: [id], onDelete: Cascade)
    quizResult QuizResult @relation(fields: [quizResultId], references: [id], onDelete: Cascade)
    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    @@index([questionId])
    @@index([quizResultId])
}

model QuizStudentSettings {
    id String @id @default(uuid())
    studentId String
    quizId String
    maxAttempts Int // Per-student maximum number of attempts (overrides quiz.maxAttempts)
    user User @relation(fields: [studentId], references: [id], onDelete: Cascade)
    quiz Quiz @relation(fields: [quizId], references: [id], onDelete: Cascade)
    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    @@unique([studentId, quizId])
    @@index([studentId])
    @@index([quizId])
}

model PromoCode {
    id String @id @default(uuid())
    code String @unique // رمز الكوبون
    discountType String // "PERCENTAGE" or "FIXED"
    discountValue Float // قيمة الخصم (نسبة أو مبلغ ثابت)
    minPurchase Float? // الحد الأدنى للشراء (اختياري)
    maxDiscount Float? // الحد الأقصى للخصم (للمناسب) (اختياري)
    usageLimit Int? // الحد الأقصى لعدد مرات الاستخدام (اختياري)
    usedCount Int @default(0) // عدد مرات الاستخدام الحالية
    isActive Boolean @default(true) // هل الكوبون نشط
    validFrom DateTime? // تاريخ بداية الصلاحية (اختياري)
    validUntil DateTime? // تاريخ انتهاء الصلاحية (اختياري)
    description String? @db.Text // وصف الكوبون (اختياري)
    courses PromoCodeCourse[] // الكورسات التي ينطبق عليها الكوبون (فارغ يعني جميع الكورسات)
    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    @@index([code])
    @@index([isActive])
}

model PromoCodeCourse {
    id String @id @default(uuid())
    promocodeId String
    courseId String
    promocode PromoCode @relation(fields: [promocodeId], references: [id], onDelete: Cascade)
    course Course @relation(fields: [courseId], references: [id], onDelete: Cascade)
    createdAt DateTime @default(now())

    @@unique([promocodeId, courseId])
    @@index([promocodeId])
    @@index([courseId])
}